
import json
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, MessageHandler, Filters, CallbackContext, ConversationHandler

# == Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ==
TOKEN = "7390710856:AAGgxZKsyg6tL47IA-KwWVwe66dv85eSBdc"
OWNER_ID = 671524794  # Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ

# == Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª ==
DATA_FILE = "store_data.json"

# == Ø­ÙˆØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø§Øª ==
ADDING_CATEGORY, ADDING_PRODUCT_NAME, ADDING_PRODUCT_DESC, ADDING_PRODUCT_PRICE, SELECTING_CATEGORY = range(5)

# == ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==
def load_data():
    if not os.path.exists(DATA_FILE):
        with open(DATA_FILE, 'w') as f:
            json.dump({"categories": {}}, f)
    with open(DATA_FILE, 'r') as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, 'w') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

# == Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª ==
def start(update: Update, context: CallbackContext):
    update.message.reply_text("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„Ù…ØªØ¬Ø±! Ø§Ø³ØªØ®Ø¯Ù… /add_category Ø£Ùˆ /add_product Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª.")

# == Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ ==
def is_owner(user_id):
    return user_id == OWNER_ID

# == Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ ==
def add_category(update: Update, context: CallbackContext):
    if not is_owner(update.effective_user.id):
        return update.message.reply_text("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.")
    update.message.reply_text("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
    return ADDING_CATEGORY

def save_category(update: Update, context: CallbackContext):
    category = update.message.text.strip()
    data = load_data()
    if category in data["categories"]:
        update.message.reply_text("Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§.")
    else:
        data["categories"][category] = []
        save_data(data)
        update.message.reply_text(f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ: {category}")
    return ConversationHandler.END

# == Ø¹Ø±Ø¶ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ==
def list_categories(update: Update, context: CallbackContext):
    data = load_data()
    keyboard = [[InlineKeyboardButton(cat, callback_data=f"cat:{cat}")] for cat in data["categories"]]
    if keyboard:
        update.message.reply_text("Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ:", reply_markup=InlineKeyboardMarkup(keyboard))
    else:
        update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.")

# == Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙ ==
def category_selected(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    category = query.data.split(":")[1]
    data = load_data()
    products = data["categories"].get(category, [])
    if products:
        msg = f"ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ {category}:

"
        for p in products:
            msg += f"ğŸ”¸ {p['name']} - {p['price']} Ø±ÙŠØ§Ù„
{p['desc']}

"
    else:
        msg = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ."
    query.edit_message_text(msg)

# == Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ==
def add_product(update: Update, context: CallbackContext):
    if not is_owner(update.effective_user.id):
        return update.message.reply_text("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.")
    data = load_data()
    if not data["categories"]:
        return update.message.reply_text("Ø£Ø¶Ù ØªØµÙ†ÙŠÙÙ‹Ø§ Ø£ÙˆÙ„Ù‹Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… /add_category")
    update.message.reply_text("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:")
    return ADDING_PRODUCT_NAME

def get_product_name(update: Update, context: CallbackContext):
    context.user_data["new_product"] = {"name": update.message.text.strip()}
    update.message.reply_text("Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬:")
    return ADDING_PRODUCT_DESC

def get_product_desc(update: Update, context: CallbackContext):
    context.user_data["new_product"]["desc"] = update.message.text.strip()
    update.message.reply_text("Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ (Ø±Ù‚Ù… ÙÙ‚Ø·):")
    return ADDING_PRODUCT_PRICE

def get_product_price(update: Update, context: CallbackContext):
    try:
        price = float(update.message.text.strip())
        context.user_data["new_product"]["price"] = price
    except ValueError:
        return update.message.reply_text("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù„Ù„Ø³Ø¹Ø±.")
    data = load_data()
    categories = list(data["categories"].keys())
    keyboard = [[InlineKeyboardButton(cat, callback_data=f"add_to_cat:{cat}")] for cat in categories]
    update.message.reply_text("Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„ÙŠÙ‡:", reply_markup=InlineKeyboardMarkup(keyboard))
    return SELECTING_CATEGORY

def assign_product_to_category(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    category = query.data.split(":")[1]
    data = load_data()
    data["categories"][category].append(context.user_data["new_product"])
    save_data(data)
    query.edit_message_text("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.")
    return ConversationHandler.END

# == Ø¥Ù„ØºØ§Ø¡ ==
def cancel(update: Update, context: CallbackContext):
    update.message.reply_text("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.")
    return ConversationHandler.END

# == ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ==
def main():
    updater = Updater(TOKEN)
    dp = updater.dispatcher

    # Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    conv_add_cat = ConversationHandler(
        entry_points=[CommandHandler("add_category", add_category)],
        states={ADDING_CATEGORY: [MessageHandler(Filters.text & ~Filters.command, save_category)]},
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    conv_add_product = ConversationHandler(
        entry_points=[CommandHandler("add_product", add_product)],
        states={
            ADDING_PRODUCT_NAME: [MessageHandler(Filters.text & ~Filters.command, get_product_name)],
            ADDING_PRODUCT_DESC: [MessageHandler(Filters.text & ~Filters.command, get_product_desc)],
            ADDING_PRODUCT_PRICE: [MessageHandler(Filters.text & ~Filters.command, get_product_price)],
            SELECTING_CATEGORY: [CallbackQueryHandler(assign_product_to_category, pattern="^add_to_cat:")],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    # Ø£ÙˆØ§Ù…Ø±
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("list_categories", list_categories))
    dp.add_handler(CallbackQueryHandler(category_selected, pattern="^cat:"))
    dp.add_handler(conv_add_cat)
    dp.add_handler(conv_add_product)

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
